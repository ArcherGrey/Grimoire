(window.webpackJsonp=window.webpackJsonp||[]).push([[226],{625:function(v,_,e){"use strict";e.r(_);var t=e(19),c=Object(t.a)({},(function(){var v=this,_=v.$createElement,e=v._self._c||_;return e("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[e("h1",{attrs:{id:"xss-和-csrf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#xss-和-csrf"}},[v._v("#")]),v._v(" XSS 和 csrf")]),v._v(" "),e("h2",{attrs:{id:"xss"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#xss"}},[v._v("#")]),v._v(" XSS")]),v._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[v._v("概念")]),v._v(" "),e("p",[v._v("Cross-Site Scripting（跨站脚本攻击）简称 XSS，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。")])]),v._v(" "),e("p",[e("s",[v._v("为了和 CSS 区分，这里把攻击的第一个字母改成了 X，于是叫做 XSS。")])]),v._v(" "),e("p",[v._v("XSS 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。")]),v._v(" "),e("p",[v._v("不仅仅是业务上的“用户的 "),e("code",[v._v("UGC")]),v._v(" 内容”可以进行注入，包括 "),e("code",[v._v("URL")]),v._v(" 上的参数等都可以是攻击的来源。在处理输入时，以下内容都不可信：")]),v._v(" "),e("ul",[e("li",[v._v("来自用户的 "),e("code",[v._v("UGC")]),v._v(" 信息")]),v._v(" "),e("li",[v._v("来自第三方的链接")]),v._v(" "),e("li",[e("code",[v._v("URL")]),v._v(" 参数")]),v._v(" "),e("li",[e("code",[v._v("POST")]),v._v(" 参数")]),v._v(" "),e("li",[e("code",[v._v("Referer")]),v._v(" （可能来自不可信的来源）")]),v._v(" "),e("li",[e("code",[v._v("Cookie")]),v._v(" （可能来自其他子域注入）")])]),v._v(" "),e("p",[v._v("分类")]),v._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"center"}},[v._v("类型")]),v._v(" "),e("th",{staticStyle:{"text-align":"center"}},[v._v("存储区")]),v._v(" "),e("th",{staticStyle:{"text-align":"center"}},[v._v("插入点")])])]),v._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"center"}},[v._v("存储型 XSS")]),v._v(" "),e("td",{staticStyle:{"text-align":"center"}},[v._v("后端数据库")]),v._v(" "),e("td",{staticStyle:{"text-align":"center"}},[v._v("HTML")])]),v._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[v._v("反射型 XSS")]),v._v(" "),e("td",{staticStyle:{"text-align":"center"}},[v._v("URL")]),v._v(" "),e("td",{staticStyle:{"text-align":"center"}},[v._v("HTML")])]),v._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"center"}},[v._v("DOM 型 XSS")]),v._v(" "),e("td",{staticStyle:{"text-align":"center"}},[v._v("后端数据库/前端存储/URL")]),v._v(" "),e("td",{staticStyle:{"text-align":"center"}},[v._v("前端 JavaScript")])])])]),v._v(" "),e("p",[v._v("存储型 "),e("code",[v._v("XSS")]),v._v(" 的攻击步骤：")]),v._v(" "),e("ol",[e("li",[v._v("攻击者将恶意代码提交到目标网站的数据库中。")]),v._v(" "),e("li",[v._v("用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 "),e("code",[v._v("HTML")]),v._v(" 中返回给浏览器。")]),v._v(" "),e("li",[v._v("用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。")]),v._v(" "),e("li",[v._v("恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。")])]),v._v(" "),e("p",[v._v("这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。")]),v._v(" "),e("p",[v._v("反射型 "),e("code",[v._v("XSS")]),v._v(" 的攻击步骤：")]),v._v(" "),e("ol",[e("li",[v._v("攻击者构造出特殊的 "),e("code",[v._v("URL")]),v._v("，其中包含恶意代码。")]),v._v(" "),e("li",[v._v("用户打开带有恶意代码的 "),e("code",[v._v("URL")]),v._v(" 时，网站服务端将恶意代码从 "),e("code",[v._v("URL")]),v._v(" 中取出，拼接在 "),e("code",[v._v("HTML")]),v._v(" 中返回给浏览器。")]),v._v(" "),e("li",[v._v("用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。")]),v._v(" "),e("li",[v._v("恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。")])]),v._v(" "),e("p",[v._v("反射型 "),e("code",[v._v("XSS")]),v._v(" 跟存储型 "),e("code",[v._v("XSS")]),v._v(" 的区别是：存储型 "),e("code",[v._v("XSS")]),v._v(" 的恶意代码存在数据库里，反射型 "),e("code",[v._v("XSS")]),v._v(" 的恶意代码存在 "),e("code",[v._v("URL")]),v._v(" 里。")]),v._v(" "),e("p",[v._v("反射型 "),e("code",[v._v("XSS")]),v._v(" 漏洞常见于通过 "),e("code",[v._v("URL")]),v._v(" 传递参数的功能，如网站搜索、跳转等。\n由于需要用户主动打开恶意的 "),e("code",[v._v("URL")]),v._v(" 才能生效，攻击者往往会结合多种手段诱导用户点击。\n"),e("code",[v._v("POST")]),v._v(" 的内容也可以触发反射型 "),e("code",[v._v("XSS")]),v._v("，只不过其触发条件比较苛刻（需要构造表单提交页面，并引导用户点击），所以非常少见。")]),v._v(" "),e("p",[e("code",[v._v("DOM")]),v._v(" 型 "),e("code",[v._v("XSS")]),v._v(" 的攻击步骤：")]),v._v(" "),e("ol",[e("li",[v._v("攻击者构造出特殊的 "),e("code",[v._v("URL")]),v._v("，其中包含恶意代码。")]),v._v(" "),e("li",[v._v("用户打开带有恶意代码的 "),e("code",[v._v("URL")]),v._v("。")]),v._v(" "),e("li",[v._v("用户浏览器接收到响应后解析执行，前端 "),e("code",[v._v("JavaScript")]),v._v(" 取出 "),e("code",[v._v("URL")]),v._v(" 中的恶意代码并执行。")]),v._v(" "),e("li",[v._v("恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。")])]),v._v(" "),e("p",[e("code",[v._v("DOM")]),v._v(" 型 "),e("code",[v._v("XSS")]),v._v(" 跟前两种 "),e("code",[v._v("XSS")]),v._v(" 的区别："),e("code",[v._v("DOM")]),v._v(" 型 "),e("code",[v._v("XSS")]),v._v(" 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 "),e("code",[v._v("JavaScript")]),v._v(" 自身的安全漏洞，而其他两种 "),e("code",[v._v("XSS")]),v._v(" 都属于服务端的安全漏洞。")]),v._v(" "),e("h3",{attrs:{id:"预防"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#预防"}},[v._v("#")]),v._v(" 预防")]),v._v(" "),e("p",[e("code",[v._v("XSS")]),v._v(" 攻击有两大要素：")]),v._v(" "),e("ul",[e("li",[v._v("攻击者提交恶意代码")]),v._v(" "),e("li",[v._v("浏览器执行恶意代码\n"),e("ul",[e("li",[v._v("防止 "),e("code",[v._v("html")]),v._v(" 注入")]),v._v(" "),e("li",[v._v("防止 "),e("code",[v._v("js")]),v._v(" 执行恶意代码")])])])]),v._v(" "),e("p",[v._v("预防存储型和反射型 "),e("code",[v._v("XSS")]),v._v(" 攻击:")]),v._v(" "),e("ul",[e("li",[v._v("纯前端渲染，把代码和数据分离\n"),e("ol",[e("li",[v._v("浏览器先加载一个静态 "),e("code",[v._v("HTML")]),v._v("，此 "),e("code",[v._v("HTML")]),v._v(" 中不包含任何跟业务相关的数据。")]),v._v(" "),e("li",[v._v("然后浏览器执行 "),e("code",[v._v("HTML")]),v._v(" 中的 "),e("code",[v._v("JavaScript")]),v._v("。")]),v._v(" "),e("li",[e("code",[v._v("JavaScript")]),v._v(" 通过 "),e("code",[v._v("Ajax")]),v._v(" 加载业务数据，调用 "),e("code",[v._v("DOM API")]),v._v(" 更新到页面上。")])])]),v._v(" "),e("li",[v._v("对 "),e("code",[v._v("html")]),v._v(" 充分转义")])]),v._v(" "),e("p",[v._v("预防 "),e("code",[v._v("DOM")]),v._v(" 型 "),e("code",[v._v("XSS")]),v._v(" 攻击:")]),v._v(" "),e("ul",[e("li",[v._v("在使用 "),e("code",[v._v(".innerHTML、.outerHTML、document.write()")]),v._v(" 时要特别小心，不要把不可信的数据作为 "),e("code",[v._v("HTML")]),v._v(" 插到页面上，而应尽量使用 "),e("code",[v._v(".textContent、.setAttribute()")]),v._v(" 等。")]),v._v(" "),e("li",[v._v("如果用 "),e("code",[v._v("Vue/React")]),v._v(" 技术栈，并且不使用 "),e("code",[v._v("v-html/dangerouslySetInnerHTML")]),v._v(" 功能，就在前端 "),e("code",[v._v("render")]),v._v(" 阶段避免 "),e("code",[v._v("innerHTML、outerHTML")]),v._v(" 的 "),e("code",[v._v("XSS")]),v._v(" 隐患。")]),v._v(" "),e("li",[e("code",[v._v("DOM")]),v._v(" 中的内联事件监听器，如 "),e("code",[v._v("location、onclick、onerror、onload、onmouseover")]),v._v(" 等，"),e("code",[v._v("<a>")]),v._v(" 标签的 "),e("code",[v._v("href")]),v._v(" 属性，"),e("code",[v._v("JavaScript")]),v._v(" 的 "),e("code",[v._v("eval()、setTimeout()、setInterval()")]),v._v(" 等，都能把字符串作为代码运行。如果不可信的数据拼接到字符串中传递给这些 "),e("code",[v._v("API")]),v._v("，很容易产生安全隐患，请务必避免。")])]),v._v(" "),e("h3",{attrs:{id:"通用方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#通用方案"}},[v._v("#")]),v._v(" 通用方案")]),v._v(" "),e("p",[e("code",[v._v("Content Security Policy")]),v._v("\n严格的 "),e("code",[v._v("CSP")]),v._v(" 在 "),e("code",[v._v("XSS")]),v._v(" 的防范中可以起到以下的作用：")]),v._v(" "),e("ul",[e("li",[v._v("禁止加载外域代码，防止复杂的攻击逻辑。")]),v._v(" "),e("li",[v._v("禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。")]),v._v(" "),e("li",[v._v("禁止内联脚本执行（规则较严格，目前发现 "),e("code",[v._v("GitHub")]),v._v(" 使用）。")]),v._v(" "),e("li",[v._v("禁止未授权的脚本执行（新特性，"),e("code",[v._v("Google Map")]),v._v(" 移动版在使用）。")]),v._v(" "),e("li",[v._v("合理使用上报可以及时发现 "),e("code",[v._v("XSS")]),v._v("，利于尽快修复问题。")])]),v._v(" "),e("p",[v._v("输入内容长度控制\n对于不受信任的输入，都应该限定一个合理的长度。虽然无法完全防止 "),e("code",[v._v("XSS")]),v._v(" 发生，但可以增加 "),e("code",[v._v("XSS")]),v._v(" 攻击的难度。")]),v._v(" "),e("p",[v._v("其他安全措施")]),v._v(" "),e("ul",[e("li",[e("code",[v._v("HTTP-only Cookie")]),v._v(": 禁止 "),e("code",[v._v("JavaScript")]),v._v(" 读取某些敏感 "),e("code",[v._v("Cookie")]),v._v("，攻击者完成 "),e("code",[v._v("XSS")]),v._v(" 注入后也无法窃取此 "),e("code",[v._v("Cookie")]),v._v("。")]),v._v(" "),e("li",[v._v("验证码：防止脚本冒充用户提交危险操作。")])]),v._v(" "),e("h2",{attrs:{id:"csrf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#csrf"}},[v._v("#")]),v._v(" CSRF")]),v._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[v._v("概念")]),v._v(" "),e("p",[e("code",[v._v("CSRF")]),v._v(" ("),e("code",[v._v("Cross-site request forgery")]),v._v(") 跨站请求伪造：攻击者诱导受害者进入第三方网站，在第三方网站中，向被攻击网站发送跨站请求。利用受害者在被攻击网站已经获取的注册凭证，绕过后台的用户验证，达到冒充用户对被攻击的网站执行某项操作的目的")])]),v._v(" "),e("p",[v._v("攻击流程：")]),v._v(" "),e("ol",[e("li",[v._v("受害者登录 "),e("code",[v._v("a.com")]),v._v("，并保留了登录凭证（"),e("code",[v._v("Cookie")]),v._v("）。")]),v._v(" "),e("li",[v._v("攻击者引诱受害者访问了 "),e("code",[v._v("b.com")]),v._v("。")]),v._v(" "),e("li",[e("code",[v._v("b.com")]),v._v(" 向 "),e("code",[v._v("a.com")]),v._v(" 发送了一个请求："),e("code",[v._v("a.com/act=xx")]),v._v("。")]),v._v(" "),e("li",[e("code",[v._v("a.com")]),v._v(" 接收到请求后，对请求进行验证，并确认是受害者的凭证，误以为是受害者自己发送的请求。")]),v._v(" "),e("li",[e("code",[v._v("a.com")]),v._v(" 以受害者的名义执行了 "),e("code",[v._v("act=xx")]),v._v("。")])]),v._v(" "),e("p",[v._v("攻击完成，攻击者在受害者不知情的情况下，冒充受害者，让 "),e("code",[v._v("a.com")]),v._v(" 执行了自己定义的操作。")]),v._v(" "),e("p",[v._v("特点：")]),v._v(" "),e("ul",[e("li",[v._v("攻击一般发起在第三方网站，而不是被攻击的网站。被攻击的网站无法防止攻击发生。")]),v._v(" "),e("li",[v._v("攻击利用受害者在被攻击网站的登录凭证，冒充受害者提交操作；而不是直接窃取数据。")]),v._v(" "),e("li",[v._v("整个过程攻击者并不能获取到受害者的登录凭证，仅仅是“冒用”。")]),v._v(" "),e("li",[v._v("跨站请求可以用各种方式：图片 URL、超链接、CORS、Form 提交等等。部分请求方式可以直接嵌入在第三方论坛、文章中，难以进行追踪")])]),v._v(" "),e("h2",{attrs:{id:"防护策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#防护策略"}},[v._v("#")]),v._v(" 防护策略")]),v._v(" "),e("ul",[e("li",[v._v("阻止不明外域访问\n"),e("ul",[e("li",[v._v("同源检测\n"),e("ul",[e("li",[v._v("origin header")]),v._v(" "),e("li",[v._v("referer header")])])]),v._v(" "),e("li",[v._v("Samesite Cookie")])])]),v._v(" "),e("li",[v._v("提交时要求附加本域才能获取的信息\n"),e("ul",[e("li",[v._v("CSRF Token")]),v._v(" "),e("li",[v._v("双重 Cookie 验证\n"),e("ul",[e("li",[v._v("域名添加 "),e("code",[v._v("cookie")]),v._v(" 参数内容随机，发送请求把它添加到参数中")])])])])])])])}),[],!1,null,null,null);_.default=c.exports}}]);